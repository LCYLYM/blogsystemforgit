{% extends 'base.html' %}
{% block head %}
<meta name="description" content="{{ blogBase['title'] }} search page">
<title>{{ blogBase['title'] }} - Tag</title>
{% endblock %}

{% block style %}
<style>
.chip{display:inline-flex;align-items:center;gap:8px;}
</style>
{% endblock %}

{% block header %}
<div class="text-2xl font-black tracking-tighter cursor-pointer select-none" onclick="setTheme('ethereal')">
    <span id="logo-text">VOID.</span>
</div>

<div class="flex gap-3 items-center">
    <div class="flex items-center gap-2 bg-white/5 backdrop-blur-md px-4 py-2 rounded-full border border-white/10">
        <i data-lucide="search" class="w-4 h-4"></i>
        <input id="tagSearch" type="search" class="bg-transparent outline-none text-sm w-44" placeholder="Search title..." value="">
        <button class="text-sm font-bold opacity-70 hover:opacity-100 transition" type="button" onclick="searchShow()">{{ i18n['Search'] }}</button>
    </div>
    <a href="{{ blogBase['homeUrl'] }}" class="px-4 py-2 rounded-full border border-white/10 hover:bg-white/5 transition text-sm" title="{{ i18n['home'] }}">
        <span class="inline-flex items-center gap-2"><i data-lucide="home" class="w-4 h-4"></i>Home</span>
    </a>
    <div class="flex gap-2 items-center bg-white/5 backdrop-blur-md px-2 py-2 rounded-full border border-white/10 shadow-2xl">
        <button onclick="setTheme('ethereal')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition" title="虚空流体"><i data-lucide="droplets" class="w-5 h-5"></i></button>
        <button onclick="setTheme('cyber')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition" title="赛博故障"><i data-lucide="terminal-square" class="w-5 h-5"></i></button>
        <button onclick="setTheme('oil')" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-white/10 transition" title="印象派油画"><i data-lucide="palette" class="w-5 h-5"></i></button>
    </div>
</div>
{% endblock %}

{% block content %}
<header class="mb-10">
    <h1 class="text-4xl md:text-6xl font-black tracking-tight" id="tagTitle">Tag</h1>
    <p class="opacity-70 mt-4">按标签筛选或直接搜索标题。</p>
</header>

<div id="taglabel" class="flex flex-wrap gap-3 mb-10"></div>

<div class="grid" style="grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 3rem;" id="tagGrid"></div>

<div class="notFind" style="display:none;font-size:24px;margin:8px;">Not Find</div>
{% endblock %}

{% block script %}
<script>
const SITE_TITLE = {{ blogBase["title"]|tojson }};
let tagList = [];
let labelsCount = {};
let jsonData = null;

const tagGrid = document.getElementById('tagGrid');
const taglabel = document.getElementById('taglabel');
const tagTitle = document.getElementById('tagTitle');

function escapeHtml(s){
    return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
}

function fetchJson(){
    const request = new XMLHttpRequest();
    request.open('GET', 'postList.json');
    request.responseType = 'text';
    request.send();
    request.onload = function(){
        jsonData = JSON.parse(request.response);
        buildLabels();
        setClassDisplay(decodeURI(window.location.hash.slice(1)) || 'All');
    };
}

function buildLabels(){
    jsonData['labelColorDict']["All"] = '#000';
    labelsCount['All'] = 0;
    for (const key in jsonData) {
        if (key !== 'labelColorDict' && Array.isArray(jsonData[key]['labels'])) {
            labelsCount['All']++;
            for (const label of jsonData[key]['labels']) {
                labelsCount[label] = (labelsCount[label] || 0) + 1;
            }
        }
    }

    const sortedLabelsList = Object.keys(labelsCount).sort((a, b) => labelsCount[b] - labelsCount[a]);
    taglabel.innerHTML = '';
    tagList = [];
    for (const label of sortedLabelsList) {
        tagList.push(label);
        const btn = document.createElement('button');
        btn.className = 'px-4 py-2 rounded-full text-sm border border-white/10 hover:bg-white/5 transition';
        btn.style.backgroundColor = jsonData['labelColorDict'][label];
        btn.style.color = '#fff';
        btn.innerHTML = `<span class="chip"><span>${escapeHtml(label)}</span><span class="opacity-70">${labelsCount[label]}</span></span>`;
        btn.onclick = () => updateShowTag(label);
        taglabel.appendChild(btn);
    }
}

function renderCards(list){
    tagGrid.innerHTML = list.map((p, idx) => {
        const category = (p.labels && p.labels.length) ? p.labels[0] : 'POST';
        return `
            <a href="${escapeHtml(p.postUrl)}" class="card flex flex-col h-full group cursor-pointer" style="animation-delay:${idx * 100}ms">
                <div class="p-6 flex flex-col flex-grow relative z-10">
                    <div class="text-xs opacity-50 mb-3 font-mono">${escapeHtml(p.createdDate || '')}</div>
                    <div class="text-[10px] font-bold px-2 py-1 rounded border border-white/20 inline-block w-fit mb-4" style="background: rgba(0,0,0,0.35); color: #fff;">${escapeHtml(category)}</div>
                    <h3 class="text-2xl font-bold mb-3 leading-tight">${escapeHtml(p.postTitle || '')}</h3>
                    <div class="mt-auto flex items-center text-xs font-bold uppercase tracking-widest opacity-60 group-hover:opacity-100 transition-opacity">
                        Read More <i data-lucide="arrow-up-right" class="w-4 h-4 ml-1"></i>
                    </div>
                </div>
            </a>
        `;
    }).join('');

    if(window.lucide && typeof window.lucide.createIcons === 'function'){
        window.lucide.createIcons();
    }
    if(window.anime){
        window.anime({
            targets: '.card',
            translateY: [50, 0],
            opacity: [0, 1],
            delay: window.anime.stagger(80),
            duration: 700,
            easing: 'easeOutExpo'
        });
    }
}

function updateShowTag(label){
    if(window.location.hash.slice(1) !== encodeURI(label)){
        window.location.hash = '#' + label;
        setClassDisplay(label);
    }
}

function setClassDisplay(label){
    tagTitle.textContent = label === 'All' ? 'All' : `Tag: ${label}`;
    document.title = `${label} - ${SITE_TITLE}`;
    document.getElementById('tagSearch').value = '';

    if(label === 'All'){
        const list = Object.keys(jsonData)
            .filter(k => k !== 'labelColorDict')
            .map(k => jsonData[k]);
        renderCards(list);
        document.getElementsByClassName('notFind')[0].style.display='none';
        return;
    }

    if(tagList.indexOf(label) !== -1){
        const list = Object.keys(jsonData)
            .filter(k => k !== 'labelColorDict')
            .map(k => jsonData[k])
            .filter(p => Array.isArray(p.labels) && p.labels.indexOf(label) !== -1);
        renderCards(list);
        document.getElementsByClassName('notFind')[0].style.display='none';
        return;
    }

    document.getElementById('tagSearch').value = label;
    searchShow();
}

function searchShow(){
    const searchInput = document.getElementById('tagSearch').value || '';
    tagTitle.textContent = searchInput ? `Search: ${searchInput}` : 'Search';
    document.title = (searchInput ? searchInput : 'Search') + ' - ' + SITE_TITLE;
    window.location.hash = '#' + searchInput;

    const list = Object.keys(jsonData)
        .filter(k => k !== 'labelColorDict')
        .map(k => jsonData[k])
        .filter(p => (p.postTitle || '').toUpperCase().indexOf(searchInput.toUpperCase()) !== -1);

    renderCards(list);
    const nf = document.getElementsByClassName('notFind')[0];
    if(list.length === 0){
        nf.style.display='block';
        nf.textContent = `Not Find "${searchInput}"`;
    }else{
        nf.style.display='none';
    }
}

fetchJson();

</script>
{% endblock %}
